#!/bin/bash
# ============================================================
# SunSea Steel Website â€” æœåŠ¡å™¨ä¸€é”®æ›´æ–°
# è¿è¡Œ: cd /www/wwwroot/steel-trader && bash server-update.sh
# ============================================================

set -e
GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; RED='\033[0;31m'; NC='\033[0m'
ok()  { echo -e "${GREEN}âœ… $1${NC}"; }
info(){ echo -e "${BLUE}âœ  $1${NC}"; }
warn(){ echo -e "${YELLOW}âš ï¸  $1${NC}"; }

echo ""
echo "============================================================"
echo "  SunSea Steel â€” ä¸€é”®æ›´æ–° $(date '+%Y-%m-%d %H:%M:%S')"
echo "============================================================"
echo ""

[ ! -f "package.json" ] && echo -e "${RED}âŒ è¯·åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ: cd /www/wwwroot/steel-trader${NC}" && exit 1

# â”€â”€ 1. æ‹‰å–æœ€æ–°ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "ä» GitHub æ‹‰å–æœ€æ–°ä»£ç ..."
git fetch origin

LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse @{u} 2>/dev/null || echo "unknown")

if [ "$LOCAL" = "$REMOTE" ]; then
  warn "ä»£ç å·²æ˜¯æœ€æ–°ï¼Œæ˜¯å¦å¼ºåˆ¶é‡å»ºï¼Ÿ(y/n) "
  read -r -n 1 REPLY; echo
  [[ ! $REPLY =~ ^[Yy]$ ]] && echo "å·²å–æ¶ˆ" && exit 0
fi

git pull
ok "ä»£ç : $(git log --oneline -1)"

# â”€â”€ 2. å®‰è£…ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "npm install..."
npm install
ok "ä¾èµ–å°±ç»ª"

# â”€â”€ 3. é‡æ–°æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "npm run build..."
npm run build
ok "æ„å»ºå®Œæˆ"

# â”€â”€ 4. é‡å¯ PM2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "é‡å¯ PM2..."
pm2 restart steel-trader 2>/dev/null || pm2 start ecosystem.config.cjs
pm2 save
ok "PM2 å·²é‡å¯"
echo ""
pm2 status

echo ""
echo "============================================================"
ok "ğŸ‰ æ›´æ–°å®Œæˆï¼$(date '+%H:%M:%S')"
echo "============================================================"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—: pm2 logs steel-trader --lines 30"
