<template>
  <div class="company-page">
    <h1>å…¬å¸ä¿¡æ¯ç®¡ç†</h1>
    
    <div class="card">
      <div class="card-body">
        <form @submit.prevent="handleSubmit">
          <div class="grid grid-2">
            <div class="form-group">
              <label>å…¬å¸åç§°ï¼ˆä¸­æ–‡ï¼‰</label>
              <input v-model="form.name" type="text" class="form-control" />
            </div>
            <div class="form-group">
              <label>å…¬å¸åç§°ï¼ˆè‹±æ–‡ï¼‰</label>
              <input v-model="form.name_en" type="text" class="form-control" />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>å…¬å¸ç®€ä»‹ï¼ˆä¸­æ–‡ï¼‰</label>
              <textarea v-model="form.description" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label>å…¬å¸ç®€ä»‹ï¼ˆè‹±æ–‡ï¼‰</label>
              <textarea v-model="form.description_en" class="form-control" rows="4"></textarea>
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>è”ç³»ç”µè¯</label>
              <input v-model="form.phone" type="text" class="form-control" />
            </div>
            <div class="form-group">
              <label>é‚®ç®±åœ°å€</label>
              <input v-model="form.email" type="email" class="form-control" />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>WhatsApp</label>
              <input v-model="form.whatsapp" type="text" class="form-control" />
            </div>
            <div class="form-group">
              <label>å¾®ä¿¡å·</label>
              <input v-model="form.wechat" type="text" class="form-control" />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>å…¬å¸åœ°å€ï¼ˆä¸­æ–‡ï¼‰</label>
              <input v-model="form.address" type="text" class="form-control" />
            </div>
            <div class="form-group">
              <label>å…¬å¸åœ°å€ï¼ˆè‹±æ–‡ï¼‰</label>
              <input v-model="form.address_en" type="text" class="form-control" />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>ä¼ä¸šä¼˜åŠ¿ï¼ˆä¸­æ–‡ï¼Œæ¯è¡Œä¸€æ¡ï¼‰</label>
              <textarea v-model="form.advantages" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label>ä¼ä¸šä¼˜åŠ¿ï¼ˆè‹±æ–‡ï¼Œæ¯è¡Œä¸€æ¡ï¼‰</label>
              <textarea v-model="form.advantages_en" class="form-control" rows="4"></textarea>
            </div>
          </div>

          <h3 class="section-title">ç¤¾äº¤åª’ä½“é“¾æ¥</h3>
          <p class="form-hint">å¡«å†™å®Œæ•´é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://www.facebook.com/yourpage</p>

          <div class="grid grid-2">
            <div class="form-group">
              <label>Facebook é“¾æ¥</label>
              <input v-model="form.facebook" type="url" class="form-control" placeholder="https://www.facebook.com/..." />
            </div>
            <div class="form-group">
              <label>LinkedIn é“¾æ¥</label>
              <input v-model="form.linkedin" type="url" class="form-control" placeholder="https://www.linkedin.com/..." />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>Instagram é“¾æ¥</label>
              <input v-model="form.instagram" type="url" class="form-control" placeholder="https://www.instagram.com/..." />
            </div>
            <div class="form-group">
              <label>TikTok é“¾æ¥</label>
              <input v-model="form.tiktok" type="url" class="form-control" placeholder="https://www.tiktok.com/..." />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>X (Twitter) é“¾æ¥</label>
              <input v-model="form.twitter" type="url" class="form-control" placeholder="https://x.com/..." />
            </div>
          </div>

          <h3 class="section-title">å›¾ç‰‡è®¾ç½®</h3>

          <div class="grid grid-3">
            <div class="form-group">
              <label>å…¬å¸ Logo</label>
              <p class="form-hint">å»ºè®®å°ºå¯¸ï¼š200Ã—60pxï¼ŒPNG/SVGæ ¼å¼ï¼Œé€æ˜èƒŒæ™¯</p>
              <input type="file" @change="e => logoFile = e.target.files[0]" accept="image/*" />
              <div class="preview-box" v-if="form.logo || logoFile">
                <img :src="logoFile ? getPreviewUrl(logoFile) : form.logo" />
              </div>
            </div>
            <div class="form-group">
              <label>ç½‘ç«™å›¾æ ‡ (Favicon)</label>
              <p class="form-hint">å»ºè®®å°ºå¯¸ï¼š32Ã—32px æˆ– 64Ã—64pxï¼ŒICO/PNGæ ¼å¼</p>
              <input type="file" @change="e => faviconFile = e.target.files[0]" accept=".ico,.png,.svg,image/*" />
              <div class="preview-box preview-small" v-if="form.favicon || faviconFile">
                <img :src="faviconFile ? getPreviewUrl(faviconFile) : form.favicon" />
              </div>
            </div>
            <div class="form-group">
              <label>å…³äºæˆ‘ä»¬é¡µé¢å›¾ç‰‡</label>
              <p class="form-hint">å»ºè®®å°ºå¯¸ï¼š800Ã—600pxï¼ŒJPG/PNGæ ¼å¼</p>
              <input type="file" @change="e => aboutImageFile = e.target.files[0]" accept="image/*" />
              <div class="preview-box" v-if="form.about_image || aboutImageFile">
                <img :src="aboutImageFile ? getPreviewUrl(aboutImageFile) : form.about_image" />
              </div>
            </div>
          </div>

          <h3 class="section-title">äºŒç»´ç å›¾ç‰‡</h3>

          <div class="grid grid-2">
            <div class="form-group">
              <label>WhatsApp äºŒç»´ç </label>
              <p class="form-hint">ä¸Šä¼  WhatsApp äºŒç»´ç å›¾ç‰‡ï¼Œæ˜¾ç¤ºåœ¨äº§å“è¯¦æƒ…é¡µè”ç³»é¢æ¿ä¸­</p>
              <input type="file" @change="e => whatsappQrFile = e.target.files[0]" accept="image/*" />
              <div class="preview-box" v-if="form.whatsapp_qr || whatsappQrFile">
                <img :src="whatsappQrFile ? getPreviewUrl(whatsappQrFile) : form.whatsapp_qr" />
              </div>
            </div>
            <div class="form-group">
              <label>å¾®ä¿¡ äºŒç»´ç </label>
              <p class="form-hint">ä¸Šä¼ å¾®ä¿¡äºŒç»´ç å›¾ç‰‡ï¼Œæ˜¾ç¤ºåœ¨äº§å“è¯¦æƒ…é¡µè”ç³»é¢æ¿ä¸­</p>
              <input type="file" @change="e => wechatQrFile = e.target.files[0]" accept="image/*" />
              <div class="preview-box" v-if="form.wechat_qr || wechatQrFile">
                <img :src="wechatQrFile ? getPreviewUrl(wechatQrFile) : form.wechat_qr" />
              </div>
            </div>
          </div>

          <h3 class="section-title">ğŸ“ Google åœ°å›¾åµŒå…¥</h3>
          <div class="form-group">
            <label>Google Maps åµŒå…¥é“¾æ¥ <span class="form-hint-inline">ï¼ˆä» Google Maps â†’ åˆ†äº« â†’ åµŒå…¥åœ°å›¾ â†’ å¤åˆ¶ src="" é‡Œçš„é“¾æ¥ï¼‰</span></label>
            <input v-model="form.map_embed_url" type="url" class="form-control" placeholder="https://www.google.com/maps/embed?pb=..." />
            <p class="form-hint">å¡«å†™åï¼Œè”ç³»æˆ‘ä»¬é¡µé¢ä¼šæ˜¾ç¤ºä¸€ä¸ªåµŒå…¥å¼ Google åœ°å›¾ï¼Œæ–¹ä¾¿å®¢æˆ·å®šä½ã€‚å¦‚æœä¸å¡«ï¼Œåˆ™ä¸æ˜¾ç¤ºåœ°å›¾ã€‚</p>
            <div v-if="form.map_embed_url" class="map-preview">
              <iframe :src="form.map_embed_url" width="100%" height="200" style="border:0;border-radius:8px;" allowfullscreen="" loading="lazy"></iframe>
            </div>
          </div>

          <button type="submit" class="btn btn-primary" :disabled="loading">
            {{ loading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
          </button>
        </form>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import api from '../../api'

const loading = ref(false)
const logoFile = ref(null)
const faviconFile = ref(null)
const aboutImageFile = ref(null)
const whatsappQrFile = ref(null)
const wechatQrFile = ref(null)

const form = reactive({
  name: '', name_en: '',
  description: '', description_en: '',
  phone: '', email: '',
  address: '', address_en: '',
  whatsapp: '', wechat: '',
  facebook: '', linkedin: '', instagram: '', tiktok: '', twitter: '',
  logo: '', favicon: '', about_image: '',
  whatsapp_qr: '', wechat_qr: '',
  advantages: '', advantages_en: '',
  map_embed_url: ''
})

const getPreviewUrl = (file) => {
  return URL.createObjectURL(file)
}

const handleSubmit = async () => {
  loading.value = true
  try {
    const formData = new FormData()
    Object.keys(form).forEach(key => {
      if (!['logo', 'favicon', 'about_image', 'whatsapp_qr', 'wechat_qr'].includes(key)) {
        formData.append(key, form[key] || '')
      }
    })
    if (logoFile.value) formData.append('logo', logoFile.value)
    if (faviconFile.value) formData.append('favicon', faviconFile.value)
    if (aboutImageFile.value) formData.append('about_image', aboutImageFile.value)
    if (whatsappQrFile.value) formData.append('whatsapp_qr', whatsappQrFile.value)
    if (wechatQrFile.value) formData.append('wechat_qr', wechatQrFile.value)

    await api.updateCompany(formData)
    alert('ä¿å­˜æˆåŠŸ')
    // åˆ·æ–°æ•°æ®
    const data = await api.getCompany()
    Object.keys(form).forEach(key => {
      form[key] = data[key] || ''
    })
    logoFile.value = null
    faviconFile.value = null
    aboutImageFile.value = null
    whatsappQrFile.value = null
    wechatQrFile.value = null
  } catch (e) {
    alert(e.message)
  } finally {
    loading.value = false
  }
}

onMounted(async () => {
  try {
    const data = await api.getCompany()
    Object.keys(form).forEach(key => {
      if (data[key]) form[key] = data[key]
    })
  } catch (e) {
    console.error(e)
  }
})
</script>

<style scoped>
.company-page h1 {
  margin-bottom: 24px;
}

.section-title {
  margin: 30px 0 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
  font-size: 18px;
}

.form-hint {
  font-size: 12px;
  color: var(--secondary);
  margin: 4px 0 8px;
}

.preview-box {
  margin-top: 10px;
  width: 120px;
  height: 90px;
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f8f9fa;
}

.preview-box.preview-small {
  width: 64px;
  height: 64px;
}

.preview-box img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}
</style>
